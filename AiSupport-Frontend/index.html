<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <title>Knowsio</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" type="image/png" href="logo.png" />
  <!-- Tailwind back (your pages depend on these utilities) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Your extra styles if any -->
  <link rel="stylesheet" href="style.css">
  <style>
    /* minimal extras for login overlay (not in Tailwind) */
    #login-overlay { position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; z-index:50; }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">
  <!-- Header -->
  <header class="flex items-center p-4 bg-white shadow">
    <img src="logo.png" alt="Knowsio Logo" class="h-10 w-auto">
    <h1 class="ml-3 text-xl font-semibold text-gray-800">Knowsio</h1>
    <button id="reloginBtn" 
            class="ml-auto text-sm bg-gray-900 text-white px-3 py-1.5 rounded hover:bg-black">
      Opnieuw inloggen
    </button>
  </header>

  <!-- App shell (hidden until /me succeeds) -->
  <div id="app-shell" class="flex h-[calc(100vh-4rem)] hidden">
    <!-- Sidebar (original, tidy, small avatars) -->
    <aside class="w-64 bg-white shadow-md p-4 flex flex-col">
      <nav class="space-y-3">
        <button onclick="loadPage('lara')" class="flex items-center space-x-2 w-full text-left py-2 px-3 rounded hover:bg-gray-200">
          <img src="Lara_small.png" alt="Lara" class="w-6 h-6 rounded-full">
          <span>Lara</span>
        </button>
        <button onclick="loadPage('lotte')" class="flex items-center space-x-2 w-full text-left py-2 px-3 rounded hover:bg-gray-200">
          <img src="Lotte_small.png" alt="Lotte" class="w-6 h-6 rounded-full">
          <span>Lotte</span>
        </button>
        <button onclick="loadPage('taken')" class="w-full text-left py-2 px-3 rounded hover:bg-gray-200">Takenlijst</button>
      </nav>

      <!-- User panel pinned to bottom -->
      <div class="mt-auto border-t pt-3 text-sm">
        <div class="text-gray-500">Signed in</div>
        <div class="truncate" id="user-email">—</div>
        <div class="text-gray-500 mt-2">Org / Provider</div>
        <div class="truncate"><span id="user-org">—</span> · <span id="user-prov">—</span></div>
        <button id="logout" class="mt-3 w-full bg-gray-100 text-gray-900 py-2 rounded hover:bg-gray-200">Logout</button>
      </div>
    </aside>

    <!-- Main content mount -->
    <main id="content" class="flex-1 p-6 overflow-auto">
      <!-- loadPage() will inject content here -->
    </main>
  </div>

  <!-- Login overlay -->
  <div id="login-overlay" role="dialog" aria-modal="true" class="hidden">
    <div class="w-[340px] bg-white border border-gray-200 rounded-xl p-5 shadow-xl">
      <h2 class="text-lg font-semibold mb-3">Sign in</h2>
      <form id="login-form" autocomplete="on" class="grid gap-3">
        <input name="email" type="email" placeholder="email" required class="px-3 py-2 border rounded"/>
        <input name="password" type="password" placeholder="password" required class="px-3 py-2 border rounded"/>
        <div id="login-error" class="text-red-600 text-sm min-h-[18px]"></div>
        <button class="bg-gray-900 text-white px-4 py-2 rounded hover:bg-black" type="submit">Login</button>
      </form>
    </div>
  </div>

  <!-- Auth + app wiring -->
  <script type="module">
    // ======== Config ========
    const API = window.location.origin; // same-origin via Nginx

    // ======== Helpers ========
    const $ = (id) => document.getElementById(id);
    const appShell = $('app-shell');
    const loginOverlay = $('login-overlay');
    const loginForm = $('login-form');
    const loginError = $('login-error');
    const userEmail = $('user-email');
    const userOrg = $('user-org');
    const userProv = $('user-prov');

    function setToken(t){ localStorage.setItem('token', t); }
    function getToken(){ return localStorage.getItem('token'); }
    function clearToken(){ localStorage.removeItem('token'); }

    async function api(path, opts = {}) {
      const headers = { ...(opts.headers||{}), 'Content-Type': 'application/json' };
      const t = getToken(); if (t) headers.Authorization = `Bearer ${t}`;
      const res = await fetch(`${API}${path}`, { ...opts, headers });
      const data = await res.json().catch(() => ({}));
      
      let data = null;
      try { data = await res.json(); } catch {}

      if (res.status === 401) {
        clearToken();
        showLogin('Sessietoken is verlopen. Log opnieuw in.');
        throw new Error('401 unauthorized');
      }
      if (!res.ok) {
        const msg = data?.error || `HTTP ${res.status}`;
        throw new Error(msg);
      }
      return data ?? {};
    }
    
    function showApp(me) {
      userEmail.textContent = me.email || '—';
      userOrg.textContent = me.org_key || '—';
      userProv.textContent = me.provider || '—';

      loginOverlay.classList.add('hidden');
      appShell.classList.remove('hidden');

      // Load default page with Tailwind styling active
      if (typeof loadPage === 'function') loadPage('lara');
    }
    function showLogin(errMsg = '') {
      // wipe any sensitive UI
      const mount = document.getElementById('content');
      if (mount) mount.innerHTML = '';
      // hide app shell, show overlay
      appShell.classList.add('hidden');
      loginOverlay.classList.remove('hidden');
      loginError.textContent = errMsg;
    }

    // ======== Bootstrap: try token via /me ========
    (async () => {
      try {
        const me = await api('/me').then(d => d.user);
        if (!me) throw new Error('No user');
        showApp(me);
      } catch {
        showLogin();
      }
    })();

    // ======== Login flow ========
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      loginError.textContent = '';
      const form = new FormData(loginForm);
      const email = form.get('email');
      const password = form.get('password');

      try {
        const out = await api('/auth/login', {
          method:'POST',
          body: JSON.stringify({ email, password })
        });
        setToken(out.token);
        const me = await api('/me').then(d => d.user);
        showApp(me);
      } catch (err) {
        showLogin(err.message);
      }
    });

    // ======== Logout ========
    $('logout').addEventListener('click', () => {
      clearToken();
      showLogin('Je bent uitgelogd.');
    });

    $('reloginBtn').addEventListener('click', () => {
      clearToken();
      showLogin();
    });


  </script>

  <!-- Your app logic: defines loadPage(), initLara(), initLotte(), etc. -->
  <script src="scripts.js"></script>
</body>
</html>
